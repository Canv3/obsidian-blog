<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Google：12 条 Golang 最佳实践 | PrintLove</title><meta name=keywords content="program_golang"><meta name=description content="12 条 Golang 最佳实践，并在原文基础上增加了解读与补充"><meta name=author content="Evan Miao"><link rel=canonical href=https://www.gby.ai/go-bestpractices/><link crossorigin=anonymous href=/assets/css/stylesheet.0f4d06feb7a00553d7b46603ca44aaca1dd036cd7082d6cecf39137242c0cb9e.css integrity="sha256-D00G/regBVPXtGYDykSqyh3QNs1wgtbOzzkTckLAy54=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.gby.ai/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.gby.ai/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.gby.ai/favicon-32x32.png><link rel=apple-touch-icon href=https://www.gby.ai/apple-touch-icon.png><link rel=mask-icon href=https://www.gby.ai/safari_pinned_tab.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://npm.elemecdn.com/lxgw-wenkai-screen-webfont@1.7.0/style.css media=print onload='this.media="all"'><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?4bddc7ae6f2203e19017f349bdcc79c2",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-VE0D4BXTS2"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VE0D4BXTS2",{anonymize_ip:!1})}</script><meta property="og:title" content="Google：12 条 Golang 最佳实践"><meta property="og:description" content="12 条 Golang 最佳实践，并在原文基础上增加了解读与补充"><meta property="og:type" content="article"><meta property="og:url" content="https://www.gby.ai/go-bestpractices/"><meta property="og:image" content="https://images.unsplash.com/photo-1526045566106-788438d25353?q=80&w=1000&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-27T11:14:56+08:00"><meta property="article:modified_time" content="2021-10-27T11:14:56+08:00"><meta property="og:site_name" content="PrintLove"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://images.unsplash.com/photo-1526045566106-788438d25353?q=80&w=1000&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"><meta name=twitter:title content="Google：12 条 Golang 最佳实践"><meta name=twitter:description content="12 条 Golang 最佳实践，并在原文基础上增加了解读与补充"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.gby.ai/posts/"},{"@type":"ListItem","position":2,"name":"Google：12 条 Golang 最佳实践","item":"https://www.gby.ai/go-bestpractices/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Google：12 条 Golang 最佳实践","name":"Google：12 条 Golang 最佳实践","description":"12 条 Golang 最佳实践，并在原文基础上增加了解读与补充","keywords":["program_golang"],"articleBody":"这是直接总结好的 12 条，详细的再继续往下看：\n先处理错误避免嵌套 尽量避免重复 先写最重要的代码 给代码写文档注释 命名尽可能简洁 使用多文件包 使用 go get 可获取你的包 了解自己的需求 保持包的独立性 避免在内部使用并发 使用 Goroutine 管理状态 避免 Goroutine 泄露 最佳实践 这是一篇翻译文章，为了使读者更好的理解，会在原文翻译的基础增加一些讲解或描述。\n来在维基百科：\n\"A best practice is a method or technique that has consistently shown results superior\rto those achieved with other means\"\r最佳实践是一种方法或技术，其结果始终优于其他方式。\r写 Go 代码时的技术要求：\n简单性 可读性 可维护性 样例代码 需要优化的代码。\ntype Gopher struct { Name string AgeYears int } func (g *Gopher) WriteTo(w io.Writer) (size int64, err error) { err = binary.Write(w, binary.LittleEndian, int32(len(g.Name))) if err == nil { size += 4 var n int n, err = w.Write([]byte(g.Name)) size += int64(n) if err == nil { err = binary.Write(w, binary.LittleEndian, int64(g.AgeYears)) if err == nil { size += 4 } return } return } return } 看看上面的代码，自己先思索在代码编写方式上怎么更好，我先简单说下代码意思是啥：\n将 Name 和 AgeYears 字段数据存入 io.Writer 类型中。 如果存入的数据是 string 或 []byte 类型，再追加其长度数据。 如果对 binary 这个标准包不知道怎么使用，就看看我的另一篇文章 《快速了解 “小字端” 和 “大字端” 及 Go 语言中的使用》。\n先处理错误避免嵌套 func (g *Gopher) WriteTo(w io.Writer) (size int64, err error) { err = binary.Write(w, binary.LittleEndian, int32(len(g.Name))) if err != nil { return } size += 4 n, err := w.Write([]byte(g.Name)) size += int64(n) if err != nil { return } err = binary.Write(w, binary.LittleEndian, int64(g.AgeYears)) if err == nil { size += 4 } return } 减少判断错误的嵌套，会使读者看起来更轻松。\n尽量避免重复 上面代码中 WriteTo 方法中的 Write 出现了 3 次，比较重复，精简后如下：\ntype binWriter struct { w io.Writer size int64 err error } // Write writes a value to the provided writer in little endian form. func (w *binWriter) Write(v interface{}) { if w.err != nil { return } if w.err = binary.Write(w.w, binary.LittleEndian, v); w.err == nil { w.size += int64(binary.Size(v)) } } 使用 binWriter 结构体。\nfunc (g *Gopher) WriteTo(w io.Writer) (int64, error) { bw := \u0026binWriter{w: w} bw.Write(int32(len(g.Name))) bw.Write([]byte(g.Name)) bw.Write(int64(g.AgeYears)) return bw.size, bw.err } type-switch 处理不同类型 func (w *binWriter) Write(v interface{}) { if w.err != nil { return } switch v.(type) { case string: s := v.(string) w.Write(int32(len(s))) w.Write([]byte(s)) case int: i := v.(int) w.Write(int64(i)) default: if w.err = binary.Write(w.w, binary.LittleEndian, v); w.err == nil { w.size += int64(binary.Size(v)) } } } func (g *Gopher) WriteTo(w io.Writer) (int64, error) { bw := \u0026binWriter{w: w} bw.Write(g.Name) bw.Write(g.AgeYears) return bw.size, bw.err } type-switch 精简 摒弃了上面代码的 v.(string) 、v.(int) 类型反射使用。\nfunc (w *binWriter) Write(v interface{}) { if w.err != nil { return } switch x := v.(type) { case string: w.Write(int32(len(x))) w.Write([]byte(x)) case int: w.Write(int64(x)) default: if w.err = binary.Write(w.w, binary.LittleEndian, v); w.err == nil { w.size += int64(binary.Size(v)) } } } 进入不同分支，x 变量对应的就是该分支的类型。\n自行决定是否写入 type binWriter struct { w io.Writer buf bytes.Buffer err error } // Write writes a value to the provided writer in little endian form. func (w *binWriter) Write(v interface{}) { if w.err != nil { return } switch x := v.(type) { case string: w.Write(int32(len(x))) w.Write([]byte(x)) case int: w.Write(int64(x)) default: w.err = binary.Write(\u0026w.buf, binary.LittleEndian, v) } } // Flush writes any pending values into the writer if no error has occurred. // If an error has occurred, earlier or with a write by Flush, the error is // returned. func (w *binWriter) Flush() (int64, error) { if w.err != nil { return 0, w.err } return w.buf.WriteTo(w.w) } func (g *Gopher) WriteTo(w io.Writer) (int64, error) { bw := \u0026binWriter{w: w} bw.Write(g.Name) bw.Write(g.AgeYears) return bw.Flush() } WriteTo 方法中，分了两大部分，增加了灵活性：\n组装信息 调用 Flush 方法来决定是否写入 w。 函数适配器 func init() { http.HandleFunc(\"/\", handler) } func handler(w http.ResponseWriter, r *http.Request) { err := doThis() if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) log.Printf(\"handling %q: %v\", r.RequestURI, err) return } err = doThat() if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) log.Printf(\"handling %q: %v\", r.RequestURI, err) return } } 函数 handler 包含了业务的逻辑和错误处理，下来将错误处理单独写一个函数处理，代码修改如下：\nfunc init() { http.HandleFunc(\"/\", errorHandler(betterHandler)) } func errorHandler(f func(http.ResponseWriter, *http.Request) error) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { err := f(w, r) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) log.Printf(\"handling %q: %v\", r.RequestURI, err) } } } func betterHandler(w http.ResponseWriter, r *http.Request) error { if err := doThis(); err != nil { return fmt.Errorf(\"doing this: %v\", err) } if err := doThat(); err != nil { return fmt.Errorf(\"doing that: %v\", err) } return nil } 组织你的代码 1. 先写最重要的 许可信息、构建信息、包文档。\nimport 语句：相关联组使用空行分隔。\nimport ( \"fmt\" \"io\" \"log\" \"golang.org/x/net/websocket\" ) 其余代码，以最重要的类型开始，以辅助函数和类型结尾。\n2. 文档注释 包名前的相关文档。\n// Package playground registers an HTTP handler at \"/compile\" that // proxies requests to the golang.org playground service. package playground Go 语言中的标示符（变量、结构体等等）在 godoc 导出的文章中应该被正确的记录下来。\n// Author represents the person who wrote and/or is presenting the document. type Author struct { Elem []Elem } // TextElem returns the first text elements of the author details. // This is used to display the author' name, job title, and company // without the contact details. func (p *Author) TextElem() (elems []Elem) { 扩展：\n使用 godoc 工具在网页上查看 go 项目文档。\n# 安装 go get golang.org/x/tools/cmd/godoc # 启动服务 godoc -http=:6060 直接在本地访问 localhost:6060 查看文档。\n3. 命名尽可能简洁 或者说，长命名不一定好。\n尽可能找到一个可以清晰表达的简短命名，例如：\nMarshalIndent 比 MarshalWithIndentation 好。 不要忘了，在调用包内容时，会先写包名。\n在 encoding/json 包内，有一个结构体 Encoder，不要写成 JSONEncoder。 这样被使用 json.Encoder 。 4. 多文件包 是否应该将一个包拆分到多个文件？\n应避免代码太长 标准包 net/http 总共 15734 行代码，被拆分到 47 个文件中。\n拆分代码和测试。 net/http/cookie.go 和 net/http/cookie_test.go 文件都放置在 http 包下。\n测试代码只有在测试时才被编译。\n拆分包文档 当在一个包内有多个文件时，按照惯例，创建一个 doc.go 文件编写包的文档描述。\n个人思考：当一个包的说明信息比较多时，可以考虑创建 doc.go 文件。\n5. 使用 go get 可获取你的包 当你的包被提供使用时，应该清晰的让使用者知道哪些可复用，哪些不可复用。\n所以，当一些包可能会被复用，有些则不会的情况下怎么做？\n例如：定义一些网络协议的包可能会复用，而定义一些可执行命令的包则不会。\ncmd 可执行命令的包，不提供复用 pkg 可复用的包 个人思考：如果一个项目中的可执行入口比较多，建议放置在 cmd 目录中，而对于 pkg 目录目前是不太建议，所以不用借鉴。\nAPI 1. 了解自己的需求 我们继续使用之前的 Gopher 类型。\ntype Gopher struct { Name string AgeYears int } 我们可以定义这个方法。\nfunc (g *Gopher) WriteToFile(f *os.File) (int64, error) { 但方法的参数使用具体的类型时会变得难以测试，因此我们使用接口。\nfunc (g *Gopher) WriteToReadWriter(rw io.ReadWriter) (int64, error) { 并且，当使用了接口后，我们应该只需定义我们所需要的方法。\nfunc (g *Gopher) WriteToWriter(f io.Writer) (int64, error) { 2. 保持包的独立性 import ( \"golang.org/x/talks/content/2013/bestpractices/funcdraw/drawer\" \"golang.org/x/talks/content/2013/bestpractices/funcdraw/parser\" ) // Parse the text into an executable function. f, err := parser.Parse(text) if err != nil { log.Fatalf(\"parse %q: %v\", text, err) } // Create an image plotting the function. m := drawer.Draw(f, *width, *height, *xmin, *xmax) // Encode the image into the standard output. err = png.Encode(os.Stdout, m) if err != nil { log.Fatalf(\"encode image: %v\", err) } 代码中 Draw 方法接受了 Parse 函数返回的 f 变量，从逻辑上看 drawer 包依赖 parser 包，下来看看如何取消这种依赖性。\nparser 包：\ntype ParsedFunc struct { text string eval func(float64) float64 } func Parse(text string) (*ParsedFunc, error) { f, err := parse(text) if err != nil { return nil, err } return \u0026ParsedFunc{text: text, eval: f}, nil } func (f *ParsedFunc) Eval(x float64) float64 { return f.eval(x) } func (f *ParsedFunc) String() string { return f.text } drawer 包：\nimport ( \"image\" \"golang.org/x/talks/content/2013/bestpractices/funcdraw/parser\" ) // Draw draws an image showing a rendering of the passed ParsedFunc. func DrawParsedFunc(f parser.ParsedFunc) image.Image { 使用接口类型，避免依赖。\nimport \"image\" // Function represent a drawable mathematical function. type Function interface { Eval(float64) float64 } // Draw draws an image showing a rendering of the passed Function. func Draw(f Function) image.Image { 测试：接口类型比具体类型更容易测试。\npackage drawer import ( \"math\" \"testing\" ) type TestFunc func(float64) float64 func (f TestFunc) Eval(x float64) float64 { return f(x) } var ( ident = TestFunc(func(x float64) float64 { return x }) sin = TestFunc(math.Sin) ) func TestDraw_Ident(t *testing.T) { m := Draw(ident) // Verify obtained image. 4. 避免在内部使用并发 func doConcurrently(job string, err chan error) { go func() { fmt.Println(\"doing job\", job) time.Sleep(1 * time.Second) err \u003c- errors.New(\"something went wrong!\") }() } func main() { jobs := []string{\"one\", \"two\", \"three\"} errc := make(chan error) for _, job := range jobs { doConcurrently(job, errc) } for _ = range jobs { if err := \u003c-errc; err != nil { fmt.Println(err) } } } 如果这样做，那如果我们想同步调用 doConcurrently 该如何做？\nfunc do(job string) error { fmt.Println(\"doing job\", job) time.Sleep(1 * time.Second) return errors.New(\"something went wrong!\") } func main() { jobs := []string{\"one\", \"two\", \"three\"} errc := make(chan error) for _, job := range jobs { go func(job string) { errc \u003c- do(job) }(job) } for _ = range jobs { if err := \u003c-errc; err != nil { fmt.Println(err) } } } 对外暴露同步的函数，这样并发调用时也是容易的，同样也满足同步调用。\n最佳的并发实践 1. 使用 Goroutine 管理状态 Goroutine 之间使用一个 “通道” 或带有通道字段的 “结构体” 来通信。\ntype Server struct{ quit chan bool } func NewServer() *Server { s := \u0026Server{make(chan bool)} go s.run() return s } func (s *Server) run() { for { select { case \u003c-s.quit: fmt.Println(\"finishing task\") time.Sleep(time.Second) fmt.Println(\"task done\") s.quit \u003c- true return case \u003c-time.After(time.Second): fmt.Println(\"running task\") } } } func (s *Server) Stop() { fmt.Println(\"server stopping\") s.quit \u003c- true \u003c-s.quit fmt.Println(\"server stopped\") } func main() { s := NewServer() time.Sleep(2 * time.Second) s.Stop() } 2. 使用带缓冲的通道避免 Goroutine 泄露 func sendMsg(msg, addr string) error { conn, err := net.Dial(\"tcp\", addr) if err != nil { return err } defer conn.Close() _, err = fmt.Fprint(conn, msg) return err } func main() { addr := []string{\"localhost:8080\", \"http://google.com\"} err := broadcastMsg(\"hi\", addr) time.Sleep(time.Second) if err != nil { fmt.Println(err) return } fmt.Println(\"everything went fine\") } func broadcastMsg(msg string, addrs []string) error { errc := make(chan error) for _, addr := range addrs { go func(addr string) { errc \u003c- sendMsg(msg, addr) fmt.Println(\"done\") }(addr) } for _ = range addrs { if err := \u003c-errc; err != nil { return err } } return nil } 这段代码有个问题，如果提前返回了 err 变量，errc 通道将不会被读取，因此 Goroutine 将会阻塞。\n总结：\n在写入通道时 Goroutine 被阻塞。 Goroutine 持有对通道的引用。 通道不会被 gc 回收。 使用缓冲通道解决 Goroutine 阻塞问题。\nfunc broadcastMsg(msg string, addrs []string) error { errc := make(chan error, len(addrs)) for _, addr := range addrs { go func(addr string) { errc \u003c- sendMsg(msg, addr) fmt.Println(\"done\") }(addr) } for _ = range addrs { if err := \u003c-errc; err != nil { return err } } return nil } 如果我们不能预知通道的缓冲大小，也称容量，那该怎么办？\n创建一个传递退出状态的通道来避免 Goroutine 的泄露。\nfunc broadcastMsg(msg string, addrs []string) error { errc := make(chan error) quit := make(chan struct{}) defer close(quit) for _, addr := range addrs { go func(addr string) { select { case errc \u003c- sendMsg(msg, addr): fmt.Println(\"done\") case \u003c-quit: fmt.Println(\"quit\") } }(addr) } for _ = range addrs { if err := \u003c-errc; err != nil { return err } } return nil } 参考 原文链接：https://talks.golang.org/2013/bestpractices.slide#1\n视频链接：https://www.youtube.com/watch?v=8D3Vmm1BGoY\n","wordCount":"1578","inLanguage":"zh","image":"https://images.unsplash.com/photo-1526045566106-788438d25353?q=80\u0026w=1000\u0026auto=format\u0026fit=crop\u0026ixlib=rb-4.0.3\u0026ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D","datePublished":"2021-10-27T11:14:56+08:00","dateModified":"2021-10-27T11:14:56+08:00","author":[{"@type":"Person","name":"Evan Miao"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.gby.ai/go-bestpractices/"},"publisher":{"@type":"Organization","name":"PrintLove","logo":{"@type":"ImageObject","url":"https://www.gby.ai/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.gby.ai/ accesskey=h title="PrintLove (Alt + H)">PrintLove</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.gby.ai/archives title=文章><span>文章</span></a></li><li><a href=https://www.gby.ai/series title=系列><span>系列</span></a></li><li><a href=https://www.gby.ai/sponsor title=赞助><span>赞助</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Google：12 条 Golang 最佳实践</h1><div class=post-meta><span title='2021-10-27 11:14:56 +0800 CST'>2021-10-27</span>&nbsp;·&nbsp;Evan Miao&nbsp;|&nbsp;<a href=https://github.com/miaogaolin/workspace-obisidian-publisher/tree/main/content/posts/Google%ef%bc%9a12%20%e6%9d%a1%20Golang%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5.md rel="noopener noreferrer" target=_blank>指出问题</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#最佳实践>最佳实践</a></li><li><a href=#样例代码>样例代码</a></li><li><a href=#先处理错误避免嵌套>先处理错误避免嵌套</a></li><li><a href=#尽量避免重复>尽量避免重复</a></li><li><a href=#type-switch-处理不同类型>type-switch 处理不同类型</a></li><li><a href=#type-switch-精简>type-switch 精简</a></li><li><a href=#自行决定是否写入>自行决定是否写入</a></li><li><a href=#函数适配器>函数适配器</a></li><li><a href=#组织你的代码>组织你的代码</a><ul><li><a href=#1-先写最重要的>1. 先写最重要的</a></li><li><a href=#2-文档注释>2. 文档注释</a></li><li><a href=#3-命名尽可能简洁>3. 命名尽可能简洁</a></li><li><a href=#4-多文件包>4. 多文件包</a></li><li><a href=#5-使用-go-get-可获取你的包>5. 使用 go get 可获取你的包</a></li></ul></li><li><a href=#api>API</a><ul><li><a href=#1-了解自己的需求>1. 了解自己的需求</a></li><li><a href=#2-保持包的独立性>2. 保持包的独立性</a></li><li><a href=#4-避免在内部使用并发>4. 避免在内部使用并发</a></li></ul></li><li><a href=#最佳的并发实践>最佳的并发实践</a><ul><li><a href=#1-使用-goroutine-管理状态>1. 使用 Goroutine 管理状态</a></li><li><a href=#2-使用带缓冲的通道避免-goroutine-泄露>2. 使用带缓冲的通道避免 Goroutine 泄露</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></details></div><div class=post-content><p>这是直接总结好的 12 条，详细的再继续往下看：</p><ol><li>先处理错误避免嵌套</li><li>尽量避免重复</li><li>先写最重要的代码</li><li>给代码写文档注释</li><li>命名尽可能简洁</li><li>使用多文件包</li><li>使用 <code>go get</code> 可获取你的包</li><li>了解自己的需求</li><li>保持包的独立性</li><li>避免在内部使用并发</li><li>使用 Goroutine 管理状态</li><li>避免 Goroutine 泄露</li></ol><h2 id=最佳实践>最佳实践<a hidden class=anchor aria-hidden=true href=#最佳实践>#</a></h2><p>这是一篇翻译文章，为了使读者更好的理解，会在原文翻译的基础增加一些讲解或描述。</p><p>来在维基百科：</p><pre tabindex=0><code>&#34;A best practice is a method or technique that has consistently shown results superior  
to those achieved with other means&#34;  
  
最佳实践是一种方法或技术，其结果始终优于其他方式。  
</code></pre><p>写 Go 代码时的技术要求：</p><ul><li>简单性</li><li>可读性</li><li>可维护性</li></ul><h2 id=样例代码>样例代码<a hidden class=anchor aria-hidden=true href=#样例代码>#</a></h2><p>需要优化的代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Gopher</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>AgeYears</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>) (<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, int32(len(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> int64(<span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, int64(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>AgeYears</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>看看上面的代码，自己先思索在代码编写方式上怎么更好，我先简单说下代码意思是啥：</p><ul><li>将 <code>Name</code> 和 <code>AgeYears</code> 字段数据存入 <code>io.Writer</code> 类型中。</li><li>如果存入的数据是 <code>string</code> 或 <code>[]byte</code> 类型，再追加其长度数据。</li></ul><p>如果对 <code>binary</code> 这个标准包不知道怎么使用，就看看我的另一篇文章 <a href=/go-big-small/>《快速了解 “小字端” 和 “大字端” 及 Go 语言中的使用》</a>。</p><h2 id=先处理错误避免嵌套>先处理错误避免嵌套<a hidden class=anchor aria-hidden=true href=#先处理错误避免嵌套>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>) (<span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, int32(len(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> int64(<span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, int64(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>AgeYears</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>减少判断错误的嵌套，会使读者看起来更轻松。</p><h2 id=尽量避免重复>尽量避免重复<a hidden class=anchor aria-hidden=true href=#尽量避免重复>#</a></h2><p>上面代码中 <code>WriteTo</code> 方法中的 <code>Write</code> 出现了 3 次，比较重复，精简后如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>binWriter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>    <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>size</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span>  <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// Write writes a value to the provided writer in little endian form.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>binWriter</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, <span style=color:#a6e22e>v</span>); <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> int64(<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Size</span>(<span style=color:#a6e22e>v</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>使用 <code>binWriter</code> 结构体。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>binWriter</span>{<span style=color:#a6e22e>w</span>: <span style=color:#a6e22e>w</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>(int32(len(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>(int64(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>AgeYears</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h2 id=type-switch-处理不同类型>type-switch 处理不同类型<a hidden class=anchor aria-hidden=true href=#type-switch-处理不同类型>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>binWriter</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(int32(len(<span style=color:#a6e22e>s</span>)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>s</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(int64(<span style=color:#a6e22e>i</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, <span style=color:#a6e22e>v</span>); <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> int64(<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Size</span>(<span style=color:#a6e22e>v</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>binWriter</span>{<span style=color:#a6e22e>w</span>: <span style=color:#a6e22e>w</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>AgeYears</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h2 id=type-switch-精简>type-switch 精简<a hidden class=anchor aria-hidden=true href=#type-switch-精简>#</a></h2><p>摒弃了上面代码的 <code>v.(string)</code> 、<code>v.(int)</code> 类型反射使用。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>binWriter</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(int32(len(<span style=color:#a6e22e>x</span>)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>x</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(int64(<span style=color:#a6e22e>x</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, <span style=color:#a6e22e>v</span>); <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>size</span> <span style=color:#f92672>+=</span> int64(<span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Size</span>(<span style=color:#a6e22e>v</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>进入不同分支，<code>x</code> 变量对应的就是该分支的类型。</p><h2 id=自行决定是否写入>自行决定是否写入<a hidden class=anchor aria-hidden=true href=#自行决定是否写入>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>binWriter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>   <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>buf</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// Write writes a value to the provided writer in little endian form.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>binWriter</span>) <span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>v</span> <span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>string</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(int32(len(<span style=color:#a6e22e>x</span>)))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>x</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>int</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>(int64(<span style=color:#a6e22e>x</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>buf</span>, <span style=color:#a6e22e>binary</span>.<span style=color:#a6e22e>LittleEndian</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// Flush writes any pending values into the writer if no error has occurred.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// If an error has occurred, earlier or with a write by Flush, the error is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// returned.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>binWriter</span>) <span style=color:#a6e22e>Flush</span>() (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>buf</span>.<span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteTo</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>binWriter</span>{<span style=color:#a6e22e>w</span>: <span style=color:#a6e22e>w</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Write</span>(<span style=color:#a6e22e>g</span>.<span style=color:#a6e22e>AgeYears</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bw</span>.<span style=color:#a6e22e>Flush</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p><code>WriteTo</code> 方法中，分了两大部分，增加了灵活性：</p><ul><li>组装信息</li><li>调用 <code>Flush</code> 方法来决定是否写入 <code>w</code>。</li></ul><h2 id=函数适配器>函数适配器<a hidden class=anchor aria-hidden=true href=#函数适配器>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>handler</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>doThis</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;handling %q: %v&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RequestURI</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>doThat</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;handling %q: %v&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RequestURI</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>函数 <code>handler</code> 包含了业务的逻辑和错误处理，下来将错误处理单独写一个函数处理，代码修改如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>errorHandler</span>(<span style=color:#a6e22e>betterHandler</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>errorHandler</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span>) <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandlerFunc</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(), <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;handling %q: %v&#34;</span>, <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>RequestURI</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>betterHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>doThis</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;doing this: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>doThat</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;doing that: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h2 id=组织你的代码>组织你的代码<a hidden class=anchor aria-hidden=true href=#组织你的代码>#</a></h2><h3 id=1-先写最重要的>1. 先写最重要的<a hidden class=anchor aria-hidden=true href=#1-先写最重要的>#</a></h3><p>许可信息、构建信息、包文档。</p><p><code>import</code> 语句：相关联组使用空行分隔。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;io&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;golang.org/x/net/websocket&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>其余代码，以最重要的类型开始，以辅助函数和类型结尾。</p><h3 id=2-文档注释>2. 文档注释<a hidden class=anchor aria-hidden=true href=#2-文档注释>#</a></h3><p>包名前的相关文档。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Package playground registers an HTTP handler at &#34;/compile&#34; that
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// proxies requests to the golang.org playground service.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>playground</span>
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>Go 语言中的标示符（变量、结构体等等）在 godoc 导出的文章中应该被正确的记录下来。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Author represents the person who wrote and/or is presenting the document.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Author</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Elem</span> []<span style=color:#a6e22e>Elem</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// TextElem returns the first text elements of the author details.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// This is used to display the author&#39; name, job title, and company
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// without the contact details.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Author</span>) <span style=color:#a6e22e>TextElem</span>() (<span style=color:#a6e22e>elems</span> []<span style=color:#a6e22e>Elem</span>) {
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p><strong>扩展</strong>：</p><p>使用 godoc 工具在网页上查看 go 项目文档。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 安装</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>go get golang.org/x/tools/cmd/godoc
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e># 启动服务</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>godoc -http<span style=color:#f92672>=</span>:6060
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>直接在本地访问 localhost:6060 查看文档。</p><h3 id=3-命名尽可能简洁>3. 命名尽可能简洁<a hidden class=anchor aria-hidden=true href=#3-命名尽可能简洁>#</a></h3><p>或者说，长命名不一定好。</p><p>尽可能找到一个可以清晰表达的简短命名，例如：</p><ul><li><code>MarshalIndent</code> 比 <code>MarshalWithIndentation</code> 好。</li></ul><p>不要忘了，在调用包内容时，会先写包名。</p><ul><li>在 <code>encoding/json</code> 包内，有一个结构体 <code>Encoder</code>，不要写成 <code>JSONEncoder</code>。</li><li>这样被使用 <code>json.Encoder</code> 。</li></ul><h3 id=4-多文件包>4. 多文件包<a hidden class=anchor aria-hidden=true href=#4-多文件包>#</a></h3><p>是否应该将一个包拆分到多个文件？</p><ul><li>应避免代码太长</li></ul><p>标准包 <code>net/http</code> 总共 15734 行代码，被拆分到 47 个文件中。</p><ul><li>拆分代码和测试。</li></ul><p>net/http/cookie.go 和 net/http/cookie_test.go 文件都放置在 http 包下。</p><p>测试代码<strong>只有</strong>在测试时才被编译。</p><ul><li>拆分包文档</li></ul><p>当在一个包内有多个文件时，按照惯例，创建一个 doc.go 文件编写包的文档描述。</p><p><strong>个人思考</strong>：当一个包的说明信息比较多时，可以考虑创建 doc.go 文件。</p><h3 id=5-使用-go-get-可获取你的包>5. 使用 go get 可获取你的包<a hidden class=anchor aria-hidden=true href=#5-使用-go-get-可获取你的包>#</a></h3><p>当你的包被提供使用时，应该清晰的让使用者知道哪些可复用，哪些不可复用。</p><p>所以，当一些包可能会被复用，有些则不会的情况下怎么做？</p><p>例如：定义一些网络协议的包可能会复用，而定义一些可执行命令的包则不会。</p><p><img loading=lazy src=/images/20231208111271.webp alt=20231208111271.webp></p><ul><li><code>cmd</code> 可执行命令的包，不提供复用</li><li><code>pkg</code> 可复用的包</li></ul><p><strong>个人思考</strong>：如果一个项目中的可执行入口比较多，建议放置在 cmd 目录中，而对于 pkg 目录目前是不太建议，所以不用借鉴。</p><h2 id=api>API<a hidden class=anchor aria-hidden=true href=#api>#</a></h2><h3 id=1-了解自己的需求>1. 了解自己的需求<a hidden class=anchor aria-hidden=true href=#1-了解自己的需求>#</a></h3><p>我们继续使用之前的 Gopher 类型。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Gopher</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>AgeYears</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>我们可以定义这个方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteToFile</span>(<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>File</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>但方法的参数使用具体的类型时会变得难以测试，因此我们使用接口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteToReadWriter</span>(<span style=color:#a6e22e>rw</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadWriter</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>并且，当使用了接口后，我们应该只需定义我们所需要的方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>g</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Gopher</span>) <span style=color:#a6e22e>WriteToWriter</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Writer</span>) (<span style=color:#66d9ef>int64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h3 id=2-保持包的独立性>2. 保持包的独立性<a hidden class=anchor aria-hidden=true href=#2-保持包的独立性>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;golang.org/x/talks/content/2013/bestpractices/funcdraw/drawer&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;golang.org/x/talks/content/2013/bestpractices/funcdraw/parser&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// Parse the text into an executable function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>text</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;parse %q: %v&#34;</span>, <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Create an image plotting the function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>drawer</span>.<span style=color:#a6e22e>Draw</span>(<span style=color:#a6e22e>f</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>width</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>height</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>xmin</span>, <span style=color:#f92672>*</span><span style=color:#a6e22e>xmax</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Encode the image into the standard output.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>png</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Stdout</span>, <span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;encode image: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>代码中 <code>Draw</code> 方法接受了 <code>Parse</code> 函数返回的 <code>f</code> 变量，从逻辑上看 <code>drawer</code> 包依赖 <code>parser</code> 包，下来看看如何取消这种依赖性。</p><p><code>parser</code> 包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ParsedFunc</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>text</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>eval</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>text</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ParsedFunc</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>text</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ParsedFunc</span>{<span style=color:#a6e22e>text</span>: <span style=color:#a6e22e>text</span>, <span style=color:#a6e22e>eval</span>: <span style=color:#a6e22e>f</span>}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ParsedFunc</span>) <span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>float64</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>eval</span>(<span style=color:#a6e22e>x</span>) }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ParsedFunc</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span>         { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>text</span> }
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p><code>drawer</code> 包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;image&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;golang.org/x/talks/content/2013/bestpractices/funcdraw/parser&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// Draw draws an image showing a rendering of the passed ParsedFunc.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DrawParsedFunc</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>parser</span>.<span style=color:#a6e22e>ParsedFunc</span>) <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span> {
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>使用接口类型，避免依赖。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;image&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// Function represent a drawable mathematical function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Function</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Eval</span>(<span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>// Draw draws an image showing a rendering of the passed Function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Draw</span>(<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>Function</span>) <span style=color:#a6e22e>image</span>.<span style=color:#a6e22e>Image</span> {
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p><strong>测试</strong>：接口类型比具体类型更容易测试。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>drawer</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;math&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;testing&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>TestFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#a6e22e>TestFunc</span>) <span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>float64</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>(<span style=color:#a6e22e>x</span>) }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ident</span> = <span style=color:#a6e22e>TestFunc</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>x</span> <span style=color:#66d9ef>float64</span>) <span style=color:#66d9ef>float64</span> { <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span> })
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sin</span>   = <span style=color:#a6e22e>TestFunc</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Sin</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>TestDraw_Ident</span>(<span style=color:#a6e22e>t</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>T</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Draw</span>(<span style=color:#a6e22e>ident</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Verify obtained image.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  
</span></span></code></pre></div><h3 id=4-避免在内部使用并发>4. 避免在内部使用并发<a hidden class=anchor aria-hidden=true href=#4-避免在内部使用并发>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>doConcurrently</span>(<span style=color:#a6e22e>job</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;doing job&#34;</span>, <span style=color:#a6e22e>job</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;something went wrong!&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jobs</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;one&#34;</span>, <span style=color:#e6db74>&#34;two&#34;</span>, <span style=color:#e6db74>&#34;three&#34;</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errc</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>job</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>jobs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>doConcurrently</span>(<span style=color:#a6e22e>job</span>, <span style=color:#a6e22e>errc</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span> = <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>jobs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errc</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>如果这样做，那如果我们想同步调用 <code>doConcurrently</code> 该如何做？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>do</span>(<span style=color:#a6e22e>job</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;doing job&#34;</span>, <span style=color:#a6e22e>job</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;something went wrong!&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jobs</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;one&#34;</span>, <span style=color:#e6db74>&#34;two&#34;</span>, <span style=color:#e6db74>&#34;three&#34;</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errc</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>job</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>jobs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>job</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errc</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>do</span>(<span style=color:#a6e22e>job</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>job</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span> = <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>jobs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errc</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>对外暴露同步的函数，这样并发调用时也是容易的，同样也满足同步调用。</p><h2 id=最佳的并发实践>最佳的并发实践<a hidden class=anchor aria-hidden=true href=#最佳的并发实践>#</a></h2><h3 id=1-使用-goroutine-管理状态>1. 使用 Goroutine 管理状态<a hidden class=anchor aria-hidden=true href=#1-使用-goroutine-管理状态>#</a></h3><p>Goroutine 之间使用一个 “通道” 或带有通道字段的 “结构体” 来通信。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Server</span> <span style=color:#66d9ef>struct</span>{ <span style=color:#a6e22e>quit</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span> }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewServer</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Server</span>{make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>)}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>run</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>) <span style=color:#a6e22e>run</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>quit</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;finishing task&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;task done&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>quit</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>):
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;running task&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Server</span>) <span style=color:#a6e22e>Stop</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;server stopping&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>quit</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>quit</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;server stopped&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewServer</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h3 id=2-使用带缓冲的通道避免-goroutine-泄露>2. 使用带缓冲的通道避免 Goroutine 泄露<a hidden class=anchor aria-hidden=true href=#2-使用带缓冲的通道避免-goroutine-泄露>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sendMsg</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;tcp&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprint</span>(<span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;localhost:8080&#34;</span>, <span style=color:#e6db74>&#34;http://google.com&#34;</span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>broadcastMsg</span>(<span style=color:#e6db74>&#34;hi&#34;</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;everything went fine&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>broadcastMsg</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>addrs</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errc</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>addrs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errc</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sendMsg</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;done&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span> = <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>addrs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errc</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>这段代码有个问题，如果提前返回了 <code>err</code> 变量，<code>errc</code> 通道将不会被读取，因此 Goroutine 将会阻塞。</p><p><strong>总结</strong>：</p><ul><li>在写入通道时 Goroutine 被阻塞。</li><li>Goroutine 持有对通道的引用。</li><li>通道不会被 gc 回收。</li></ul><p>使用缓冲通道解决 Goroutine 阻塞问题。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>broadcastMsg</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>addrs</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errc</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, len(<span style=color:#a6e22e>addrs</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>addrs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errc</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sendMsg</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;done&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span> = <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>addrs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errc</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><p>如果我们不能预知通道的缓冲大小，也称容量，那该怎么办？</p><p>创建一个传递退出状态的通道来避免 Goroutine 的泄露。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>broadcastMsg</span>(<span style=color:#a6e22e>msg</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>addrs</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errc</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>quit</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> close(<span style=color:#a6e22e>quit</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>addrs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errc</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>sendMsg</span>(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>addr</span>):
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;done&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>quit</span>:
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;quit&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span> = <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>addrs</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errc</span>; <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><p>原文链接：<a href=https://talks.golang.org/2013/bestpractices.slide#1>https://talks.golang.org/2013/bestpractices.slide#1</a></p><p>视频链接：<a href="https://www.youtube.com/watch?v=8D3Vmm1BGoY">https://www.youtube.com/watch?v=8D3Vmm1BGoY</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.gby.ai/tags/program_golang/>program_golang</a></li></ul><nav class=paginav><a class=prev href=https://www.gby.ai/go-webhook/><span class=title>« 上一页</span><br><span>我用 Go 语言解决 Github Webhook</span></a>
<a class=next href=https://www.gby.ai/go-big-small/><span class=title>下一页 »</span><br><span>快速了解 “小字端” 和 “大字端” 及 Go 语言中的使用</span></a></nav><div class=comment-head>评论 & Email：</div><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Google：12 条 Golang 最佳实践 on x" href="https://x.com/intent/tweet/?text=@laomiao_ Google%ef%bc%9a12%20%e6%9d%a1%20Golang%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&amp;url=https%3a%2f%2fwww.gby.ai%2fgo-bestpractices%2f&amp;hashtags=program_golang"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 50 50" fill="currentcolor"><path d="M5.9199219 6 20.582031 27.375 6.2304688 44H9.4101562L21.986328 29.421875 31.986328 44H44L28.681641 21.669922 42.199219 6H39.029297L27.275391 19.617188 17.933594 6H5.9199219zm3.796875 2H16.880859L40.203125 42H33.039062L9.7167969 8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Google：12 条 Golang 最佳实践 on email" href="mailto:mglluoye@gmail.com?subject=Google%ef%bc%9a12%20%e6%9d%a1%20Golang%20%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5"><svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447 4.92893 2 7.28595 2 12 2c4.714.0 7.0711.0 8.5355 1.46447C22 4.92893 22 7.28595 22 12c0 4.714.0 7.0711-1.4645 8.5355C19.0711 22 16.714 22 12 22c-4.71405.0-7.07107.0-8.53553-1.4645C2 19.0711 2 16.714 2 12z" stroke="currentcolor" stroke-width="1.5"/><path d="M2 13H5.16026c.90517.0 1.35776.0 1.75558.183.39783.1829.69237.5266 1.28145 1.2138L8.80271 15.1032C9.39179 15.7904 9.68633 16.1341 10.0842 16.317 10.482 16.5 10.9346 16.5 11.8397 16.5H12.1603C13.0654 16.5 13.518 16.5 13.9158 16.317 14.3137 16.1341 14.6082 15.7904 15.1973 15.1032L15.8027 14.3968C16.3918 13.7096 16.6863 13.3659 17.0842 13.183 17.482 13 17.9346 13 18.8397 13H22" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/><path d="M8 7h8" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10.5h4" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round"/></svg></a></div></footer></article></main><footer class=footer><span>Content under license <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>